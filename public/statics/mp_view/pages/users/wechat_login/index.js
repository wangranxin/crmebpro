require('../common/vendor.js');(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/users/wechat_login/index"],{3714:function(t,e,n){"use strict";n.r(e);var i=n("fdb5"),o=n.n(i);for(var a in i)["default"].indexOf(a)<0&&function(t){n.d(e,t,(function(){return i[t]}))}(a);e["default"]=o.a},4114:function(t,e,n){},"6d0d":function(t,e,n){"use strict";n.d(e,"b",(function(){return i})),n.d(e,"c",(function(){return o})),n.d(e,"a",(function(){}));var i=function(){var t=this.$createElement;this._self._c},o=[]},a7a7:function(t,e,n){"use strict";n.r(e);var i=n("6d0d"),o=n("3714");for(var a in o)["default"].indexOf(a)<0&&function(t){n.d(e,t,(function(){return o[t]}))}(a);n("ca40");var c=n("828b"),s=Object(c["a"])(o["default"],i["b"],i["c"],!1,null,null,null,!1,i["a"],void 0);e["default"]=s.exports},ca40:function(t,e,n){"use strict";var i=n("4114"),o=n.n(i);o.a},e5b6:function(t,e,n){"use strict";(function(t,e){var i=n("47a9");n("f076");i(n("3240"));var o=i(n("a7a7"));t.__webpack_require_UNI_MP_PLUGIN__=n,e(o.default)}).call(this,n("3223")["default"],n("df3c")["createPage"])},fdb5:function(t,e,n){"use strict";(function(t,i){var o=n("47a9");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var a=n("4d38"),c=n("48a0"),s=n("769c"),d=n("92f9"),r=o(n("4891")),u=(o(n("998d")),o(n("89cc"))),h=getApp(),f=t.getWindowInfo().statusBarHeight+"px",l={mixins:[u.default],data:function(){return{isUp:!1,phone:"",statusBarHeight:f,isHome:!1,isPhoneBox:!1,code:"",authKey:"",options:"",userInfo:{},codeNum:0,canUseGetUserProfile:!1,canGetPrivacySetting:!1,mp_is_new:this.$Cache.get("MP_VERSION_ISNEW")||!1,configData:this.$Cache.get("BASIC_CONFIG"),imgHost:a.HTTP_REQUEST_URL,loginBg:"",protocol:!1,bindPhone:!1,isShow:!1}},components:{editUserModal:function(){Promise.all([n.e("common/vendor"),n.e("components/eidtUserModal/index")]).then(function(){return resolve(n("3d93"))}.bind(null,n)).catch(n.oe)},privacyAgreementPopup:function(){n.e("components/privacyAgreementPopup/index").then(function(){return resolve(n("b99f"))}.bind(null,n)).catch(n.oe)}},onLoad:function(e){t.getUserProfile&&(this.canUseGetUserProfile=!0);i.getPrivacySetting&&(this.canGetPrivacySetting=!0),this.userLogin();var n=getCurrentPages(),o=n[n.length-2];o&&"pages/order_addcart/order_addcart"==o.route?this.isHome=!0:this.isHome=!1},onShow:function(){t.removeStorageSync("form_type_cart")},methods:{cancelLogin:function(){t.navigateBack()},wechatAuthLogin:function(e,n){var i=this,o=this;t.showLoading({title:"正在登录中"}),(0,c.wechatAuthLogin)(e).then((function(a){if(t.hideLoading(),i.$Cache.set(s.WX_AUTH,e.code),i.$Cache.clear(s.STATE_KEY),a.data.bindPhone)i.authKey=a.data.key,t.navigateTo({url:"/pages/users/binding_phone/index?authKey=".concat(i.authKey,"&backUrl=").concat(n)});else{var c=a.data.expires_time-i.$Cache.time();i.$store.commit("LOGIN",{token:a.data.token,time:c}),o.$util.Tips({title:"登录成功",icon:"success"},{tab:4,url:n||"/pages/user/index"})}})).catch((function(e){t.hideLoading(),t.showToast({title:e,icon:"none",duration:2e3})}))},userLogin:function(){var e=this;r.default.getCode().then((function(n){e.code=n,(0,c.authType)({code:n,spread_spid:h.globalData.spid,spread_code:h.globalData.code}).then((function(t){e.authKey=t.data.key,e.bindPhone=t.data.bindPhone})).catch((function(e){t.hideLoading(),t.showToast({title:e,icon:"none",duration:2e3})}))})).catch((function(t){}))},getAuthLogin:function(){var e=this;if(!this.protocol)return this.$util.Tips({title:"请先阅读并同意协议"});t.showLoading({title:"正在登录中"}),(0,c.authLogin)({key:this.authKey}).then((function(t){var n=t.data.expires_time-e.$Cache.time();e.$store.commit("LOGIN",{token:t.data.token,time:n}),e.getUserInfo(t.data.store_user_avatar)})).catch((function(e){t.hideLoading(),t.showToast({title:e,icon:"none",duration:2e3})}))},changeIsDefault:function(t){this.$set(this,"protocol",!this.protocol)},editSuccess:function(){this.isShow=!1},closeEdit:function(){this.isShow=!1,this.$util.Tips({title:"登录成功",icon:"success"},{tab:3})},phoneLogin:function(){t.navigateTo({url:"/pages/users/binding_phone/index?authKey=".concat(this.authKey,"&pageType=0")})},onAgree:function(){this.protocol=!0},onReject:function(){t.navigateBack()},back:function(){t.navigateBack()},home:function(){t.switchTab({url:"/pages/index/index"})},maskClose:function(){this.isUp=!1},bindPhoneClose:function(t){t.isStatus?(this.isPhoneBox=!1,this.$util.Tips({title:"登录成功",icon:"success"},{tab:3})):this.isPhoneBox=!1},privacy:function(e){t.navigateTo({url:"/pages/users/privacy/index?type="+e})},getphonenumber:function(e){var n=this;return"getPhoneNumber:fail user deny"!=e.detail.errMsg&&(this.protocol?(t.showLoading({title:"正在登录中"}),void r.default.getCode().then((function(t){n.getUserPhoneNumber(e.detail.encryptedData,e.detail.iv,t)})).catch((function(e){t.$emit("closePage",!1),t.hideLoading()}))):this.$util.Tips({title:"请先阅读并同意协议"}))},getUserPhoneNumber:function(e,n,i){var o=this;(0,c.routineBindingPhone)({encryptedData:e,iv:n,code:i,spread_spid:h.globalData.spid,spread_code:h.globalData.code,key:this.authKey}).then((function(t){var e=t.data.expires_time-o.$Cache.time();o.$store.commit("LOGIN",{token:t.data.token,time:e}),o.$Cache.clear("snsapiKey"),o.getUserInfo(t.data.store_user_avatar)})).catch((function(e){o.$util.Tips({title:e}),t.hideLoading()}))},getUserInfo:function(e,n){var i=this,o=this;(0,d.getUserInfo)().then((function(n){t.hideLoading(),o.userInfo=n.data,o.$store.commit("SETUID",n.data.uid),o.$store.commit("UPDATE_USERINFO",n.data),e?i.isShow=!0:o.$util.Tips({title:"登录成功",icon:"success"},{tab:3})})).catch((function(e){t.hideLoading(),t.showToast({title:e.msg,icon:"none",duration:2e3})}))},setUserInfo:function(e){var n=this;t.showLoading({title:"正在登录中"}),r.default.getCode().then((function(t){n.getWxUser(t)})).catch((function(e){t.hideLoading()}))},getUserProfile:function(){var e=this;t.showLoading({title:"正在登录中"});var n=this;r.default.getUserProfile().then((function(i){var o=i.userInfo;o.code=e.code,o.spread_spid=h.globalData.spid||e.$Cache.get("spread"),o.spread_code=h.globalData.code,r.default.authUserInfo(o).then((function(i){if(void 0!==i.data.key&&i.data.key)t.hideLoading(),n.authKey=i.data.key,n.isPhoneBox=!0;else{t.hideLoading();var o=i.data.expires_time-n.$Cache.time();n.$store.commit("LOGIN",{token:i.data.token,time:o}),e.getUserInfo()}})).catch((function(e){t.hideLoading(),t.showToast({title:e.msg,icon:"none",duration:2e3})}))})).catch((function(e){t.hideLoading()}))},getWxUser:function(e){var n=this;r.default.getUserInfo().then((function(i){var o=i.userInfo;o.code=e,o.spread_spid=h.globalData.spid,o.spread_code=h.globalData.code,r.default.authUserInfo(o).then((function(e){if(void 0!==e.data.key&&e.data.key)t.hideLoading(),n.authKey=e.data.key,n.isPhoneBox=!0;else{t.hideLoading();var i=e.data.expires_time-n.$Cache.time();n.$store.commit("LOGIN",{token:e.data.token,time:i}),n.$util.Tips({title:e.msg,icon:"success"},{tab:3})}})).catch((function(e){t.hideLoading(),t.showToast({title:e.msg,icon:"none",duration:2e3})}))})).catch((function(e){t.hideLoading()}))}}};e.default=l}).call(this,n("df3c")["default"],n("3223")["default"])}},[["e5b6","common/runtime","common/vendor"]]]);